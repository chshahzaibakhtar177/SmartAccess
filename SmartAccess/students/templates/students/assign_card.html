{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-id-card me-2"></i>Assign NFC Card
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Student Information</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>Name:</th>
                                    <td>{{ student.name }}</td>
                                </tr>
                                <tr>
                                    <th>Roll Number:</th>
                                    <td>{{ student.roll_number }}</td>
                                </tr>
                                <tr>
                                    <th>Current Card Status:</th>
                                    <td>
                                        {% if student.nfc_uid %}
                                            <span class="badge bg-success">Card Assigned</span>
                                        {% else %}
                                            <span class="badge bg-warning">No Card Assigned</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Instructions:</h6>
                                <ul class="mb-0">
                                    <li>Make sure the NFC scanner is connected</li>
                                    <li>Have the NFC card ready to scan</li>
                                    <li>You have <strong>30 seconds</strong> to place the card</li>
                                    <li>Click "Start Scanning" when ready</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <div id="scanning-status" class="mb-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Scanning...</span>
                            </div>
                            <p class="mt-2">
                                <strong>Please place NFC card on the scanner...</strong><br>
                                <span id="countdown-timer" class="text-muted">Time remaining: 30 seconds</span>
                            </p>
                        </div>
                        
                        <div id="scan-buttons">
                            <a href="{% url 'assign_card_request' student.id %}" 
                               id="start-scan-btn" 
                               class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-play me-2"></i>Start Scanning
                            </a>
                            <a href="{% url 'dashboard_redirect' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-4">
                        <strong><i class="fas fa-exclamation-triangle"></i> Important:</strong>
                        <ul class="mb-0">
                            <li>Each card can only be assigned to one student</li>
                            <li>If the card is already assigned, you'll be asked to scan a different card</li>
                            <li>Make sure the Raspberry Pi scanner is powered on and connected</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('start-scan-btn').addEventListener('click', function(e) {
    e.preventDefault();
    
    // Show scanning status
    document.getElementById('scanning-status').style.display = 'block';
    document.getElementById('scan-buttons').style.display = 'none';
    
    // Start countdown
    let timeLeft = {{ timeout_seconds }};
    const timer = setInterval(function() {
        document.getElementById('countdown-timer').textContent = 
            `Time remaining: ${timeLeft} seconds`;
        timeLeft--;
        
        if (timeLeft < 0) {
            clearInterval(timer);
        }
    }, 1000);
    
    // Navigate to the actual scanning endpoint
    setTimeout(function() {
        window.location.href = "{% url 'assign_card_request' student.id %}";
    }, 500);
});
</script>
{% endblock %}
