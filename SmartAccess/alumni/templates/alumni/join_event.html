{% extends 'base.html' %}
{% load static %}

{% block title %}Join Event - SmartAccess{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">Join Event</h1>
        <p class="text-muted">Register for {{ event.name }}</p>
    </div>
    <div>
        <a href="{% url 'alumni:events' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Events
        </a>
    </div>
</div>

<div class="row">
    <!-- Event Details -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-info-circle"></i> Event Details
                </h6>
            </div>
            <div class="card-body">
                {% if event.image %}
                    <img src="{{ event.image.url }}" class="img-fluid rounded mb-3" alt="{{ event.name }}">
                {% endif %}
                
                <h4 class="mb-3">{{ event.name }}</h4>
                
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Date:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ event.event_date|date:"F d, Y" }}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Time:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ event.event_time|time:"g:i A" }}
                    </div>
                </div>
                
                {% if event.location %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Location:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ event.location }}
                    </div>
                </div>
                {% endif %}
                
                {% if event.category %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Category:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="badge bg-info">{{ event.category.name }}</span>
                    </div>
                </div>
                {% endif %}
                
                {% if event.max_capacity %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Capacity:</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ event.registered_count }}/{{ event.max_capacity }} registered
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ event.registration_percentage }}%" 
                                 aria-valuenow="{{ event.registered_count }}" 
                                 aria-valuemin="0" aria-valuemax="{{ event.max_capacity }}">
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if event.registration_fee and event.registration_fee > 0 %}
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <strong>Fee:</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="text-success font-weight-bold">${{ event.registration_fee }}</span>
                    </div>
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Description:</strong>
                        <p class="mt-2 text-muted">{{ event.description|default:"No description available." }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Form -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-success">
                    <i class="fas fa-user-plus"></i> Event Registration
                </h6>
            </div>
            <div class="card-body">
                <!-- Alumni Info Display -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-user"></i> Registering as:</h6>
                    <p class="mb-0">
                        <strong>{{ alumni.user.get_full_name }}</strong><br>
                        {{ alumni.course }} - Class of {{ alumni.graduation_year }}<br>
                        {{ alumni.user.email }}
                    </p>
                </div>

                <form method="post" id="registrationForm">
                    {% csrf_token %}
                    
                    {% if form.participation_type %}
                    <div class="mb-3">
                        <label for="{{ form.participation_type.id_for_label }}" class="form-label">
                            <i class="fas fa-tag"></i> Participation Type
                        </label>
                        {{ form.participation_type }}
                        {% if form.participation_type.help_text %}
                            <small class="form-text text-muted">{{ form.participation_type.help_text }}</small>
                        {% endif %}
                        {% if form.participation_type.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.participation_type.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if form.special_requirements %}
                    <div class="mb-3">
                        <label for="{{ form.special_requirements.id_for_label }}" class="form-label">
                            <i class="fas fa-clipboard-list"></i> Special Requirements / Comments
                        </label>
                        {{ form.special_requirements }}
                        <small class="form-text text-muted">Any dietary restrictions, accessibility needs, or special requests?</small>
                        {% if form.special_requirements.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.special_requirements.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Terms and Conditions -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="terms" required>
                            <label class="form-check-label" for="terms">
                                I agree to the event terms and conditions and understand that 
                                {% if event.registration_fee and event.registration_fee > 0 %}
                                    a registration fee of ${{ event.registration_fee }} may apply.
                                {% else %}
                                    this registration is binding.
                                {% endif %}
                            </label>
                        </div>
                    </div>

                    <!-- Registration Info -->
                    <div class="alert alert-light border">
                        <h6><i class="fas fa-info-circle"></i> Registration Information:</h6>
                        <ul class="mb-0">
                            <li>You will receive a confirmation email after registration</li>
                            {% if event.requires_nfc_checkin %}
                            <li>NFC check-in will be required at the event</li>
                            {% endif %}
                            <li>You can cancel your registration until 24 hours before the event</li>
                            {% if event.registration_fee and event.registration_fee > 0 %}
                            <li>Payment instructions will be provided in the confirmation email</li>
                            {% endif %}
                        </ul>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-end">
                        <a href="{% url 'alumni:events' %}" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="fas fa-user-plus"></i> Register for Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const termsCheckbox = document.getElementById('terms');

    // Add Bootstrap classes to form elements
    const formElements = document.querySelectorAll('input, textarea, select');
    formElements.forEach(element => {
        if (element.type !== 'checkbox') {
            element.classList.add('form-control');
        }
    });

    // Enable/disable submit button based on terms checkbox
    function updateSubmitButton() {
        submitBtn.disabled = !termsCheckbox.checked;
        if (termsCheckbox.checked) {
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-success');
        } else {
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-secondary');
        }
    }

    termsCheckbox.addEventListener('change', updateSubmitButton);
    updateSubmitButton(); // Initial state

    // Form submission confirmation
    form.addEventListener('submit', function(e) {
        if (!confirm('Are you sure you want to register for this event?')) {
            e.preventDefault();
        } else {
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
            submitBtn.disabled = true;
        }
    });
});
</script>

<style>
.progress {
    background-color: #e9ecef;
}

.alert-info {
    border-left: 4px solid #17a2b8;
}

.alert-light {
    border-left: 4px solid #6c757d;
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
{% endblock %}